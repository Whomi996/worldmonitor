# 世界监视器

**实时全球情报仪表板** — 在统一的态势感知界面中进行人工智能驱动的新闻聚合、地缘政治监控和基础设施跟踪。

[![GitHub stars](https://img.shields.io/github/stars/koala73/worldmonitor?style=social)](https://github.com/koala73/worldmonitor/stargazers)
[![GitHub forks](https://img.shields.io/github/forks/koala73/worldmonitor?style=social)](https://github.com/koala73/worldmonitor/network/members)
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=flat&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)
[![Last commit](https://img.shields.io/github/last-commit/koala73/worldmonitor)](https://github.com/koala73/worldmonitor/commits/main)

__持有人_0__
<a href="https://worldmonitor.app"><strong>现场演示</strong></a>  · 
<a href="https://tech.worldmonitor.app"><strong>技术变体</strong></a>  · 
<a href="./docs/DOCUMENTATION.md"><strong>完整文档</strong></a>
__持有人_0__

__持有人_0__

---

## 为什么选择世界监视器？

|问题 |解决方案 |
|---------|----------|
|新闻分散在 100 多个来源 | **单一统一仪表板** 具有 100 多个精选提要 |
|没有事件的地理空间背景 | **交互式地图** 具有 25 多个可切换数据层 |
|信息过载 | **具有焦点检测功能的人工智能合成内裤** |
|加密/宏信号噪声 | **7 信号市场雷达** 具有复合买入/现金判断 |
|昂贵的 OSINT 工具 ($$$) | **100% 免费和开源** |
|静态新闻提要| **通过实时视频流实时更新** |

---

## 现场演示

|变体 |网址 |焦点|
|---------|-----|-------|
| **世界监视器** | [worldmonitor.app](https://worldmonitor.app) |地缘政治、军事、冲突、基础设施|
| **技术监控** | [tech.worldmonitor.app](https://tech.worldmonitor.app) |初创公司、人工智能/机器学习、云、网络安全 |

两种变体都从单个代码库运行 - 只需单击一下即可在它们之间切换。

---

## 主要特点

### 互动全球地图
- **25+ 数据层** — 冲突、军事基地、核设施、海底电缆、管道、卫星火灾探测、抗议、自然灾害、数据中心等
- **智能聚类** — 标记在低变焦时智能分组，在放大时扩展
- **渐进式披露** - 细节层（基地、核、数据中心）仅在放大时出现；缩放自适应不透明度可防止世界视图混乱
- **标签消除冲突** - 重叠标签（例如，多个 BREAKING 徽章）会按优先级自动抑制，严重性最高的优先
- **8 个区域预设** — 全球、美洲、欧洲、中东和北非、亚洲、非洲、大洋洲、拉丁美洲
- **时间过滤** — 1h、6h、24h、48h、7d 事件窗口

### AI 驱动的智能
- **世界简报** — 法学硕士对全球顶级发展的综合总结（Groq Llama 3.1，Redis 缓存）
- **混合威胁分类** — 具有异步 LLM 覆盖的即时关键字分类器，以获得更高置信度的结果
- **焦点检测** — 将新闻、军事活动、抗议、中断和市场中的实体关联起来，以识别融合
- **国家不稳定指数** — 使用加权多信号混合对 20 个受监控国家进行实时稳定性评分
- **战略态势评估** — 将所有情报模块与趋势检测相结合的综合风险评分

### 实时数据层

__持有人_0__
<summary><strong>地缘政治</strong></summary>

- 活跃的冲突地区，并跟踪升级情况
- 具有新闻关联性的情报热点
- 社会骚乱事件（ACLED + GDELT）
- 制裁制度
- 天气警报和恶劣条件

__持有人_0__

__持有人_0__
<summary><strong>军事与战略</strong></summary>

- 来自 9 个运营商的 220 多个军事基地
- 实时军事飞行跟踪（ADS-B）
- 海军舰艇监控（AIS）
- 核设施和伽马辐射器
- APT 网络威胁行为者归因
- 太空港和发射设施

__持有人_0__

__持有人_0__
<summary><strong>基础设施</strong></summary>

- 带登陆点的海底电缆
- 石油和天然气管道
- AI数据中心（111个主要集群）
- 互联网中断（Cloudflare Radar）
- 重要矿藏
- NASA FIRMS 卫星火灾探测（VIIRS 热热点）

__持有人_0__

__持有人_0__
<summary><strong>市场与加密情报</strong></summary>

- 具有复合买入/现金判断的 7 信号宏雷达
- BTC 现货 ETF 流量跟踪器（IBIT、FBTC、GBTC 等 7 个）
- 稳定币挂钩健康状况监控（USDT、USDC、DAI、FDUSD、USDe）
- 具有 30 天历史的恐惧与贪婪指数
- 比特币技术趋势（SMA50、SMA200、VWAP、Mayer Multiple）
- 日元流动性信号、QQQ/XLP宏观机制、BTC算力
- 用于视觉趋势的内联 SVG 迷你图和环形仪表

__持有人_0__

__持有人_0__
<summary><strong>技术生态系统</strong>（技术变体）</summary>

- 科技公司总部（大型科技公司、独角兽公司、上市公司）
- 包含融资数据的创业中心
- 云区域（AWS、Azure、GCP）
- 加速器（YC、Techstars、500）
- 即将举行的技术会议

__持有人_0__

### 实时新闻和视频
- **100 多个 RSS 源**，涵盖地缘政治、国防、能源、科技领域
- **实时视频流** - 彭博社、天空新闻、半岛电视台、CNBC 等
- **自定义监视器** — 为任何主题创建基于关键字的警报
- **实体提取** — 自动链接国家、领导人、组织

### 信号聚合和异常检测
- **多源信号融合** - 互联网中断、军事飞行、海军舰艇、抗议、AIS 中断和卫星火灾被聚合成统一的情报图，并按国家和地区进行聚类
- **时间基线异常检测** — Welford 的在线算法计算 90 天窗口内每个事件类型、区域、工作日和月份的流均值/方差。 Z 分数阈值 (1.5/2.0/3.0) 标记偏差，例如“周四（一月）军事航班为正常水平的 3.2 倍”——通过 Upstash 存储在 Redis 中
- **区域收敛评分** - 当多种信号类型在同一地理区域出现峰值时，系统会识别收敛区域并升级严重程度

### 故事分享和社交导出
- **可共享的情报故事** — 生成国家级情报简报，其中包含 CII 分数、威胁计数、战区态势和相关预测市场
- **多平台导出** — 针对 Twitter/X、LinkedIn、WhatsApp、Telegram、Reddit 和 Facebook 的自定义格式共享，具有适合平台的格式
- **深层链接** — 每个故事都会生成一个唯一的 URL (`/story?c=<country>&t=<type>`)，其中包含动态开放图元标签，可实现丰富的社交预览
- **基于画布的图像生成** — 故事呈现为 PNG 图像以进行视觉共享，并带有 QR 码链接回实时仪表板

### 附加功能
- 具有“为什么重要”背景的信号情报
- 具有邻近相关性的基础设施级联分析
- 具有浪涌检测功能的海事和航空跟踪
- 预测市场整合（Polymarket）作为领先指标
- 服务状态监控（云提供商、AI服务）
- 通过 URL 参数共享地图状态（视图、缩放、坐标、时间范围、活动图层）
- 跨 14 个数据源的数据新鲜度监控，并提供明确的情报差距报告
- 每次馈电断路器具有 5 分钟冷却时间，以防止级联故障
- 浏览器端 ML Worker (Transformers.js)，用于 NER 和情感分析，无需服务器依赖
- **Cmd+K 搜索** — 跨新闻标题、国家和实体的模糊搜索
- **虚拟滚动** - 新闻面板仅渲染可见的 DOM 元素，处理数千个项目而不会出现浏览器延迟
- **移动检测** — 低于 768 像素的屏幕会收到警告模式，因为仪表板是为多面板桌面使用而设计的
- **UCDP 冲突分类** — 发生战争的国家（每年 1,000 人以上的战斗死亡）会自动收到 CII 下限分数，防止乐观漂移
- **HAPI 人道主义数据** — 联合国人道协调厅人道主义援助准入指标纳入国家级不稳定评分

---

## 回归测试

地图叠加行为在 Playwright 中使用地图线束 (`/map-harness.html`) 进行验证。

- 集群状态缓存初始化保护：
- `updates protest marker click payload after data refresh`
- `initializes cluster movement cache on first protest cluster render`
- 按变体运行：
- `npm run test:e2e:full -- -g "updates protest marker click payload after data refresh|initializes cluster movement cache on first protest cluster render"`
- `npm run test:e2e:tech -- -g "updates protest marker click payload after data refresh|initializes cluster movement cache on first protest cluster render"`

---

## 它是如何工作的

### 威胁分类管道

每个新闻项目都会经过两级分类管道：

1. **关键字分类器**（即时）——根据严重性等级（严重 → 高 → 中 → 低 → 信息）和类别（冲突、恐怖主义、网络、灾难等）组织的约 120 个威胁关键字进行模式匹配。立即返回置信度分数。
2. **LLM 分类器**（异步）— 通过 Vercel Edge Function 在温度 0 下调用 Groq 的 Llama 3.1 8B 在后台触发。结果缓存在 Redis 中（24 小时 TTL），由标题哈希键控。当 LLM 结果到达时，仅当其置信度较高时才会覆盖关键字结果。

这种混合方法意味着用户界面永远不会因等待人工智能而被阻塞——用户会立即看到关键字结果，LLM 改进会在几秒钟内到达，并为所有后续访问者保留。

### 国家不稳定指数 (CII)

每个受监控的国家/地区都会收到一个实时不稳定分数 (0–100)，计算公式如下：

|组件|重量 |详情 |
|-----------|--------|---------|
| **基线风险** | 40% |按国家/地区预配置，反映结构脆弱性 |
| **骚乱事件** | 20% |民主国家的抗议得分呈对数（例行抗议不会触发），独裁国家的抗议得分呈线性（每次抗议都很重要）。因死亡和互联网中断而增加|
| **安全活动** | 20% |军事飞行 (3 分) + 自有部队船只 (5 分) + 外国军事存在 (权重加倍) |
| **信息速度** | 20% |新闻提及频率按事件严重性乘数加权，针对高容量国家/地区采用对数尺度 |

额外的提升适用于热点邻近性、焦点紧迫性和冲突地区下限（例如，乌克兰固定为 ≥55，叙利亚固定为 ≥50）。

### 热点升级评分

情报热点接收混合四个标准化信号 (0–100) 的动态升级分数：

- **新闻活动** (35%) — 热点区域的文章数量和严重性
- **国家不稳定** (25%) — 东道国的 CII 分数
- **地理融合警报** (25%) — 空间分箱检测 1° 纬度/经度单元内同时发生的 3 种以上事件类型（抗议 + 军事 + 地震）
- **军事活动** (15%) — 热点附近的船只集群和飞行密度

该系统将静态基线风险 (40%) 与检测到的事件 (60%) 混合在一起，并通过 48 小时历史记录的线性回归跟踪趋势。信号发射冷却 2 小时，以防止警觉疲劳。

### 地理融合检测

事件（抗议、军事飞行、船只、地震）在 24 小时窗口内被划分到 1°×1° 的地理单元中。当 3 个以上不同的事件类型汇聚在一个单元中时，将触发汇聚警报。评分基于类型多样性（每个独特类型×25分）加上事件计数奖励（×2分）。使用冲突区域、水道和热点数据库将警报反向地理编码为人类可读的名称。

### 战略战区态势评估

九个战区不断接受军事态势升级评估：

|剧院 |按键触发|
|---------|-------------|
|伊朗/波斯湾|航母编队、油轮活动、预警机 |
|台湾海峡|中国空军出动，美国海军航母出现 |
|波罗的海/加里宁格勒| Russian Western Military District flights |
|朝鲜半岛| B-52/B-1 部署、朝鲜导弹活动 |
|东地中海|多国海军演习|
|非洲之角|反海盗巡逻、无人机活动|
|南海|航行自由行动|
|北极|远程航空巡逻|
|黑海 | ISR 飞行、海军行动 |

姿势级别从“正常”→“升高”→“严重”升级，基于以下综合因素：
- **战区飞机数量**（常驻飞机和临时飞机）
- **打击能力** - 加油机+预警机+战斗机的存在表明打击包装，而不是例行训练
- **海军存在** - 航母编队和战斗编队
- **国家不稳定** — 战区邻近国家的高 CII 分数增强了态势

每个战区都与 38 个以上的军事基地相连，能够在观察到的航班和已知的作战地点之间自动关联。

### 军事增兵和外国存在检测

该系统监控五个战区（中东、东欧、西欧、西太平洋、非洲之角）以及超过 38 个相关军事基地。它按活动类型对热点附近的船只集群进行分类：

- **部署** — 航母拥有 5 艘以上船只
- **演习** — 战斗人员列队
- **过境** — 船只经过

外国军事存在是双重的：运营商的国家被标记为部队投射，而东道国的国家被标记为外国军事威胁。 AIS 差距（黑船）被标记为潜在的信号纪律指标。

### 基础设施级联建模

除了邻近相关性之外，该系统还对中断如何通过互连基础设施传播进行建模。依赖图通过表示容量依赖关系的加权边连接海底电缆、管道、港口、阻塞点和国家：

```
Disruption Event → Affected Node → Cascade Propagation (BFS, depth ≤ 3)
                                          │
                    ┌─────────────────────┤
                    ▼                     ▼
            Direct Impact         Indirect Impact
         (e.g., cable cut)    (countries served by cable)
```

**影响计算**：`strength = edge_weight × disruption_level × (1 − redundancy)`

战略阻塞点建模捕获现实世界的依赖关系：
- **霍尔木兹海峡** — 日本石油的 80%、韩国的 70%、印度的 60%、中国的 40%
- **苏伊士运河** — 欧盟-亚洲贸易路线（德国、意大利、英国、中国）
- **马六甲海峡**——中国80%的石油过境

港口按类型加权：石油/液化天然气码头（0.9 - 关键）、集装箱港口（0.7）、海军基地（0.4 - 地缘政治但经济性较差）。这就引发了诸如“如果霍尔木兹海峡关闭，哪些国家将在30天内面临能源短缺？”之类的问题。

### 相关资产和邻近度相关性

当对新闻事件进行地理定位时，系统会自动识别 600 公里半径内的关键基础设施——管道、海底电缆、数据中心、军事基地和核设施——并按距离排名。这可以实现即时的地缘政治背景：战略要塞附近的电缆被切断、核设施附近的抗议活动或数据中心集群附近的部队调动。

### 新闻地理位置

包含 74 个中心的战略位置数据库通过关键字匹配从头条新闻推断地理位置。枢纽跨越首都、冲突地区、战略要塞（霍尔木兹海峡、苏伊士运河、马六甲海峡）和国际组织。关键层中心和活跃冲突区域的置信度评分得到提升，从而实现地图驱动的新闻投放，而无需来自 RSS 源的显式位置元数据。

### 时间基线异常检测

系统不依赖静态阈值，而是了解“正常”是什么样子并标记偏差。每种事件类型（军事航班、海军舰艇、抗议、新闻传播速度、AIS 差距、卫星火灾）均按地区进行跟踪，每个工作日和每月都有单独的基线，因为周二与周末、一月与七月的军事活动模式有所不同。

该算法使用 **Welford 的在线方法** 对均值和方差进行数值稳定的流式计算，并以 90 天的滚动窗口存储在 Redis 中。当新的观察到达时，它的 z 分数是根据学习的基线计算的。阈值：

| Z 分数 |严重程度 |示例|
|---------|----------|---------|
| ≥ 1.5 |低|抗议活动略有增加|
| ≥ 2.0 |中等|不寻常的海军存在|
| ≥ 3.0 |高/严重|军事飞行比基线高出 3 倍 |

在报告异常之前至少需要 10 个历史样本，以防止学习阶段出现误报。异常信号被吸收回信号聚合器，与其他信号混合以进行收敛检测。

### 浏览器端机器学习管道

仪表板通过 Transformers.js 在浏览器中运行完整的机器学习管道，核心智能不依赖于服务器。这在移动设备上会自动禁用以节省内存。

|能力|型号|使用|
|-----------|-------|-----|
| **文本嵌入** |句子相似度 |新闻标题的语义聚类|
| **序列分类** |威胁分类器 |威胁严重性和类别检测 |
| **总结** | T5-小号| Groq 和 OpenRouter 不可用时的回退 |
| **命名实体识别** | NER 管道 |国家、组织和领导人的提取|

**混合聚类** 将快速 Jaccard 相似度（n-gram 重叠，阈值 0.4）与 ML 精炼的语义相似度（余弦相似度，阈值 0.78）相结合。 Jaccard 在每次刷新时立即运行；当 ML Worker 加载并合并文本上不同但语义相同的集群时，语义细化就会运行（例如，“北约扩大导弹防御系统”和“联盟部署新的防空系统”）。

每个集群都会跟踪新闻速度 - 当多个第 1-2 层源在短时间内汇聚到同一个故事时，该集群将被标记为突发警报，并以 `sourcesPerHour` 作为速度指标。

### 信号聚合

所有实时数据源都会输入中央信号聚合器，构建统一的地理空间情报图。信号按国家和地区进行聚类，每个信号都带有严重性（低/中/高）、地理坐标和元数据。聚合器：

1. **按国家/地区分类** — 将来自不同来源（航班、船舶、抗议、火灾、停电）的信号分组到每个国家/地区的概况中
2. **检测区域融合** - 识别同一地理走廊中多种信号类型何时出现峰值（例如，东地中海的军事飞行+抗议+卫星火灾）
3. **提供下游分析** — CII、热点升级、焦点检测和 AI 洞察模块均使用聚合信号图片而不是原始数据

### 数据新鲜度和情报差距

单例跟踪器可监控 14 个数据源（GDELT、RSS、AIS、军事飞行、地震、天气、断电、ACLED、Polymarket、经济指标、NASA FIRMS 等），并具有状态分类：新鲜（<15 分钟）、陈旧（1 小时）、非常陈旧（6 小时）、无数据、错误、禁用。它明确报告**情报差距**（分析师看不到的内容），防止在关键数据源出现故障或降级时出现错误信心。

### 预测市场作为领先指标

使用基于标签的过滤器（乌克兰、伊朗、中国、台湾等）和 5 分钟缓存来查询 Polymarket 地缘政治市场。市场概率变化与新闻量相关：如果预测市场在匹配新闻到达之前发生显着变化，则这会被标记为潜在的预警信号。

### 宏观信号分析（市场雷达）

市场雷达面板根据完全来自免费 API（雅虎财经、mempool.space、alternative.me）的 7 个独立信号计算综合买入/现金判断：

|信号|计算|看涨何时 |
|--------|------------|--------------|
| **流动性** |日元/美元 30 天变化率 | ROC > -2%（无日元挤压）|
| **流程结构** | BTC 5 天收益 vs QQQ 5 天收益 |间隙 < 5%（对齐）|
| **宏观制度** | QQQ 20 天 ROC 与 XLP 20 天 ROC | QQQ 表现出色（风险偏好）|
| **技术趋势** | BTC vs SMA50 + 30 天成交量加权平均价格 |高于两者（看涨）|
| **哈希率** |比特币挖矿算力30天变化|增长> 3% |
| **挖矿成本** | BTC 价格与算力隐含成本 |价格 > 6 万美元（盈利）|
| **恐惧与贪婪** |另类.me 情绪指数 |值 > 50 |

总体判断要求 ≥57% 的已知信号为看涨（买入），否则现金。具有未知数据的信号被排除在分母之外。

**VWAP 计算** — 成交量加权平均价格是根据 30 天窗口内一致的价格/成交量对计算得出的。价格或交易量为空的货币对被一起排除以防止索引错位：

```
VWAP = Σ(price × volume) / Σ(volume)    for last 30 trading days
```

**梅耶倍数**（BTC 价格 / SMA200）提供了长期估值背景 - 从历史上看，高于 2.4 的值表明过热，而低于 0.8 的值表明严重低估。

### 稳定币挂钩监控

五种主要稳定币（USDT、USDC、DAI、FDUSD、USDe）通过 CoinGecko API 进行监控，并具有 2 分钟缓存。每枚代币与 1.00 美元挂钩的偏差决定了其健康状况：

|偏差|状态 |指标|
|-----------|--------|-----------|
| ≤ 0.5% |关于PEG |绿色|
| 0.5% – 1.0% |轻微DEPEG |黄色|
| > 1.0% |脱钩 |红色|

该面板汇总了稳定币总市值、24 小时交易量和整体健康状况（健康/小心/警告）。 `coins` 查询参数接受以逗号分隔的 CoinGecko ID 列表，并根据 `[a-z0-9-]+` 正则表达式进行验证以防止注入。

### BTC ETF 流量估算

通过雅虎财经的 5 天图表 API（IBIT、FBTC、ARKB、BITB、GBTC、HODL、BRRR、EZBC、BTCO、BTCW）跟踪 10 种现货比特币 ETF。由于ETF流向数据需要昂贵的终端订阅，系统根据公开信号估计流向：

- **价格变化** — 每日收盘价与前收盘价决定方向
- **成交量比率** — 当前成交量/追踪平均成交量衡量信念
- **流量大小** — `volume × price × direction × 0.1` 提供粗略的美元估算

这是一个近似值，不能替代官方流量数据，但它正确地捕获了方向和相对大小。结果缓存 15 分钟。

---

## 架构原则

|原理|实施 |
|-----------|---------------|
| **速度超越完美** |关键词分类即时； LLM 异步优化。用户永远不会等待。 |
| **假设失败** |每次馈送断路器有 5 分钟冷却时间。 AI后备链：Groq→OpenRouter→浏览器端T5。 Redis 缓存故障会正常降级。当上游 API 关闭时，每个边缘函数都会返回过时的缓存数据。 |
| **展示你看不到的东西** |情报差距跟踪器明确报告数据源中断，而不是默默地隐藏它们。 |
| **浏览器优先计算** |分析（聚类、不稳定评分、激增检测）在客户端运行——核心智能不依赖后端计算。 |
| **多信号相关性** |没有任何一个数据源是单独可信的。焦点问题需要在新闻+军事+市场+抗议之间融合，然后才能升级为关键问题。 |
| **地缘政治基础** |硬编码的冲突地区、基线国家风险和战略瓶颈可防止统计噪声在低数据区域产生错误警报。 |
| **纵深防御** | CORS 来源白名单、域白名单 RSS 代理、服务器端 API 密钥隔离、带输出编码的输入清理、AI 端点的 IP 速率限制。 |
| **缓存一切，不信任任何东西** |三层缓存（内存→Redis→上游），具有版本化缓存键和过时错误回退。每个 API 响应都包含用于调试的 `X-Cache` 标头。 |

---

## 来源可信度和 Feed 分级

每个 RSS 提要都分配有一个反映编辑可靠性的源层：

|等级 |描述 |示例 |
|------|-------------|---------|
| **1 级** |通讯社、政府官方消息来源 |路透社、美联社、BBC、国防部 |
| **2 级** |主要老店 |美国有线电视新闻网 (CNN)、纽约时报、卫报、半岛电视台 |
| **第 3 级** |专业/利基商店 |防御一号、突破防御、战区 |
| **4 级** |聚合器和博客 |谷歌新闻，个人分析师博客|

提要还带有**宣传风险评级**和**国家隶属关系标志**。为了完整起见，将国家附属来源（RT、新华社、伊朗伊斯兰共和国通讯社）纳入其中，但进行了视觉标记，以便分析人员可以考虑编辑偏见。威胁分类置信度按源层进行加权 - 在焦点检测算法中，第 1 层突发警报比第 4 层博客文章具有更大的权重。

---

## 边缘函数架构

World Monitor 使用 45 多个 Vercel Edge Functions 作为轻量级 API 层。每个边缘函数处理单个数据源问题——代理、缓存或转换外部 API。此架构避免了单一后端，同时将 API 密钥保留在服务器端：

- **RSS 代理** — 用于 100 多个提要的域允许代理，可防止 CORS 问题并隐藏源服务器。来自阻止 Vercel IP 的域的源将通过铁路中继自动路由。
- **AI Pipeline** — Groq 和 OpenRouter 边缘功能具有 Redis 重复数据删除功能，因此并发用户之间的相同标题只会触发一个 LLM 调用。分类事件端点在出现 500 个错误时暂停其队列，以避免浪费 API 配额。
- **数据适配器** - GDELT、ACLED、OpenSky、USGS、NASA FIRMS、FRED、Yahoo Finance、CoinGecko、mempool.space 等都有专用的边缘函数，可将响应标准化为一致的模式
- **市场情报** — 宏观信号、ETF 流量和稳定币监控器计算衍生分析服务器端（VWAP、SMA、挂钩偏差、流量估计）并在 Redis 中缓存结果
- **时间基线** — Welford 的算法状态跨请求保留在 Redis 中，无需传统数据库即可构建统计基线
- **自定义抓取工具** — 没有 RSS 提要的源（FwdStart、GitHub Trending、技术事件）被抓取并转换为 RSS 兼容格式

所有边缘功能都包括断路器逻辑，并在上游 API 不可用时返回缓存的陈旧数据，确保仪表板永远不会显示空白面板。

---

## 双部署架构

World Monitor 在两个协同工作的平台上运行：

```
┌─────────────────────────────────────┐
│          Vercel (Edge)              │
│  45+ edge functions · static SPA   │
│  CORS allowlist · Redis cache       │
│  AI pipeline · market analytics     │
└──────────────┬──────────────────────┘
               │ https:// (server-side)
               │ wss://   (client-side)
               ▼
┌─────────────────────────────────────┐
│       Railway (Relay Server)        │
│  WebSocket relay · OpenSky OAuth2   │
│  RSS proxy for blocked domains      │
│  AIS vessel stream multiplexer      │
└─────────────────────────────────────┘
```

**为什么是两个平台？** 多个上游 API（OpenSky Network、CNN RSS、UN News、CISA、IAEA）主动阻止来自 Vercel IP 范围的请求。 Railway 中继服务器充当备用源，处理：

- **AIS 船舶跟踪** — 维护与 AISStream.io 的持久 WebSocket 连接，并将其多路传输到所有连接的浏览器客户端，避免每个用户的连接限制
- **OpenSky 飞机数据** — 通过 OAuth2 客户端凭证流进行身份验证（Vercel IP 在没有身份验证令牌的情况下被 OpenSky 获取 403）
- **RSS 源** — 代理来自阻止 Vercel IP 的域的源，并具有单独的域白名单以确保安全

Vercel 边缘功能通过 `WS_RELAY_URL`（服务器端，HTTPS）连接到 Railway，而浏览器客户端通过 `VITE_WS_RELAY_URL`（客户端，WSS）连接。这种分离使每个部署的中继 URL 都可配置，而不会将服务器端配置泄露给浏览器。

---

## 缓存架构

每个外部 API 调用都会通过三层缓存，并具有错误失效回退功能：

```
Request → [1] In-Memory Cache → [2] Redis (Upstash) → [3] Upstream API
                                                              │
            ◄──── stale data served on error ────────────────┘
```

|等级 |范围 | TTL |目的|
|------|-------|-----|---------|
| **内存中** |每个边函数实例 |变化（60 年代–900 年代）|消除热路径的 Redis 往返 |
| **Redis (Upstash)** |跨用户、跨实例 |变化（120 秒–900 秒）|消除所有访问者之间重复的 API 调用 |
| **上游** |真相来源|不适用 |外部 API（雅虎财经、CoinGecko 等）|

缓存键具有版本控制（`opensky:v2:lamin=...`、`macro-signals:v2:default`），因此架构更改不会提供过时的格式。每个响应都包含一个用于调试的 `X-Cache` 标头（`HIT`、`REDIS-HIT`、`MISS`、`REDIS-STALE`、`REDIS-ERROR-FALLBACK`）。

AI 摘要管道添加了基于内容的重复数据删除：在调用 Groq 之前，对标题进行哈希处理并根据 Redis 检查，因此 1,000 个并发用户查看的同一突发新闻恰好会触发一次 LLM 调用。

---

## 安全模型

|层 |机制|
|-------|-----------|
| **CORS 来源许可名单** |只有 `worldmonitor.app`、`startups.worldmonitor.app` 和 `localhost:*` 可以调用 API 端点。所有其他人都收到 403。在 `api/_cors.js` 中实现。 |
| **RSS 域白名单** | RSS 代理仅从明确列出的域 (~90+) 获取。对未列出域的请求被拒绝，返回 403。
| **铁路域白名单** |铁路中继对于需要备用来源的源有一个单独的、较小的域允许列表。 |
| **API 密钥隔离** |所有 API 密钥都位于 Vercel 环境变量中的服务器端。浏览器永远看不到 Groq、OpenRouter、ACLED、Finnhub 或其他凭据。 |
| **输入净化** |面向用户的内容通过 `escapeHtml()` （防止 XSS）和 `sanitizeUrl()` （阻止 `javascript:` 和 `data:` URI）。 URL 使用 `escapeAttr()` 进行属性上下文编码。 |
| **查询参数验证** | API端点验证输入格式（例如，稳定币ID必须匹配`[a-z0-9-]+`，边界框参数是数字）。 |
| **IP速率限制** | AI 端点使用 Upstash Redis 支持的速率限制来防止滥用 Groq/OpenRouter 配额。 |
| **没有调试端点** | `api/debug-env.js` 端点在生产中返回 404 — 它仅作为禁用的占位符存在。 |

---

## 快速入门

```bash
# Clone and run
git clone https://github.com/koala73/worldmonitor.git
cd worldmonitor
npm install
vercel dev       # Runs frontend + all 45+ API edge functions
```

打开[http://localhost:3000](http://localhost:3000)

> **注意**：`vercel dev` 需要 [Vercel CLI](https://vercel.com/docs/cli) (`npm i -g vercel`)。如果您使用 `npm run dev` 代替，则只有前端启动 - 新闻源和依赖于 API 的面板将不会加载。有关详细信息，请参阅 [Self-Hosting](#self-hosting)。

### 环境变量（可选）

仪表板无需任何 API 密钥即可工作 - 未配置服务的面板根本不会出现。要获得完整功能，请复制示例文件并填写您需要的密钥：

```bash
cp .env.example .env.local
```

`.env.example` 文件记录了每个变量的描述和注册链接，按部署目标（Vercel 与 Railway）组织。关键群体：

|集团|变量|免费套餐 |
|-------|-----------|-----------|
| **人工智能** | `GROQ_API_KEY`、`OPENROUTER_API_KEY` | 14,400 个请求/天 (Groq)，50 个/天 (OpenRouter) |
| **缓存** | `UPSTASH_REDIS_REST_URL`、`UPSTASH_REDIS_REST_TOKEN` |每天 10K 个命令 |
| **市场** | `FINNHUB_API_KEY`、`FRED_API_KEY`、`EIA_API_KEY` |所有免费套餐 |
| **追踪** | `WINGBITS_API_KEY`、`AISSTREAM_API_KEY` |免费|
| **地缘政治** | `ACLED_ACCESS_TOKEN`、`CLOUDFLARE_API_TOKEN`、`NASA_FIRMS_API_KEY` |研究人员免费 |
| **继电器** | `WS_RELAY_URL`、`VITE_WS_RELAY_URL`、`OPENSKY_CLIENT_ID/SECRET` |自托管 |
| **用户界面** | `VITE_VARIANT`、`VITE_MAP_INTERACTION_MODE`（`flat` 或 `3d`，默认 `3d`）|不适用 |

有关包含注册链接的完整列表，请参阅 [`.env.example`](./.env.example)。

---

## 自托管

World Monitor 依赖 `api/` 目录中的 **45+ Vercel Edge Functions** 来实现 RSS 代理、数据缓存和 API 密钥隔离。单独运行 `npm run dev` 只会启动 Vite 前端 - 边缘功能不会执行，并且大多数面板（新闻源、市场、AI 摘要）将为空。

### 选项 1：部署到 Vercel（推荐）

最简单的路径 - Vercel 在其免费层上本地运行边缘函数：

```bash
npm install -g vercel
vercel          # Follow prompts to link/create project
```

在 Vercel 仪表板的 **设置 → 环境变量** 下添加您的 API 密钥，然后访问您的部署 URL。免费的 Hobby 计划支持所有 45 种以上的边缘功能。

### 选项 2：使用 Vercel CLI 进行本地开发

要在本地运行所有内容（前端+边缘函数）：

```bash
npm install -g vercel
cp .env.example .env.local   # Add your API keys
vercel dev                    # Starts on http://localhost:3000
```

> **重要**：使用 `vercel dev` 而不是 `npm run dev`。 Vercel CLI 在本地模拟边缘运行时，因此所有 `api/` 端点都可以工作。普通 `npm run dev` 只会启动 Vite，API 层将不可用。

### 选项 3：仅静态前端

如果您只需要地图和客户端功能（没有新闻源、没有人工智能、没有市场数据）：

```bash
npm run dev    # Vite dev server on http://localhost:5173
```

这将在没有 API 层的情况下运行前端。需要服务器端代理的面板将显示“无可用数据”。交互式地图、静态数据层（底座、电缆、管道）和浏览器端 ML 模型仍然有效。

### 平台注释

|平台|状态 |笔记|
|----------|--------|-------|
| **维塞尔** |全力支持 |推荐部署目标 |
| **Linux x86_64** |与 `vercel dev` 一起使用 |全面本地化发展 |
| **macOS** |与 `vercel dev` 一起使用 |全面本地化发展 |
| **树莓派/ARM** |部分| `vercel dev` 边缘运行时仿真可能无法在 ARM 上运行。使用选项 1（部署到 Vercel）或选项 3（静态前端）|
| **码头工人** |计划|请参阅 [Roadmap](#roadmap) |

### 铁路中继（可选）

对于实时 AIS 船舶跟踪和 OpenSky 飞机数据，请在 Railway 上部署 WebSocket 中继：

```bash
# On Railway, deploy with:
node scripts/ais-relay.cjs
```

在您的环境中设置 `WS_RELAY_URL`（服务器端，HTTPS）和 `VITE_WS_RELAY_URL`（客户端，WSS）。如果没有中继，AIS 和 OpenSky 层将无法显示实时数据，但所有其他功能都可以正常工作。

---

## 技术堆栈

|类别 |技术 |
|----------|--------------|
| **前端** | TypeScript、Vite、deck.gl (WebGL)、MapLibre GL |
| **人工智能/机器学习** | Groq (Llama 3.1 8B)、OpenRouter（后备）、Transformers.js（浏览器端 T5、NER、嵌入）|
| **缓存** | Redis (Upstash) — 内存中 + Redis + 上游、跨用户 AI 重复数据删除的 3 层缓存 |
| **地缘政治API** | OpenSky、GDELT、ACLED、UCDP、HAPI、USGS、NASA FIRMS、Polymarket、Cloudflare Radar |
| **市场 API** |雅虎财经（股票、外汇、加密货币）、CoinGecko（稳定币）、mempool.space（BTC 哈希率）、alternative.me（恐惧与贪婪）|
| **经济 API** | FRED（美联储）、EIA（能源）、Finnhub（股票报价）|
| **部署** | Vercel Edge Functions（45+ 端点）+ Railway（WebSocket 中继）|
| **数据** | 100 多个 RSS 源、ADS-B 转发器、AIS 海事数据、VIIRS 卫星图像 |

---

## 文档

完整的文档，包括算法、数据源和系统架构：

**[docs/DOCUMENTATION.md](./docs/DOCUMENTATION.md)**

关键部分：
- [Signal Intelligence](./docs/DOCUMENTATION.md#signal-intelligence)
- [Country Instability Index](./docs/DOCUMENTATION.md#country-instability-index-cii)
- [Military Tracking](./docs/DOCUMENTATION.md#military-tracking)
- [Infrastructure Analysis](./docs/DOCUMENTATION.md#infrastructure-cascade-analysis)
- [API Dependencies](./docs/DOCUMENTATION.md#api-dependencies)
- [System Architecture](./docs/DOCUMENTATION.md#system-architecture)

---

## 贡献

欢迎投稿！请参阅 [CONTRIBUTING](./docs/DOCUMENTATION.md#contributing) 了解指南。

```bash
# Development
npm run dev          # Full variant (worldmonitor.app)
npm run dev:tech     # Tech variant (startups.worldmonitor.app)

# Production builds
npm run build:full   # Build full variant
npm run build:tech   # Build tech variant

# Quality
npm run typecheck    # TypeScript type checking

# Desktop packaging
npm run desktop:package:macos:full     # .app + .dmg (World Monitor)
npm run desktop:package:macos:tech     # .app + .dmg (Tech Monitor)
npm run desktop:package:windows:full   # .exe + .msi (World Monitor)
npm run desktop:package:windows:tech   # .exe + .msi (Tech Monitor)

# Generic packaging runner
npm run desktop:package -- --os macos --variant full

# Signed packaging (same targets, requires signing env vars)
npm run desktop:package:macos:full:sign
npm run desktop:package:windows:full:sign
```

桌面版本详细信息、签名挂钩、变体输出和干净机器验证清单：
- [docs/RELEASE_PACKAGING.md](./docs/RELEASE_PACKAGING.md)

---

## 路线图

- [x] 45+ API 边缘函数用于编程访问
- [x] 双站点变体系统（地缘政治+科技）
- [x] 市场情报（宏观信号、ETF 流量、稳定币挂钩监控）
- [x] 用于 WebSocket 和阻止域代理的铁路中继
- [x] CORS 来源许可名单和安全强化
- [ ] 移动优化视图
- [ ] 重要警报的推送通知
- [ ] 历史数据回放
- [ ] 自托管 Docker 镜像

请参阅[full roadmap](./docs/DOCUMENTATION.md#roadmap)。

---

## 支持该项目

如果您发现 World Monitor 有用：

- **为这个存储库加注星标**以帮助其他人发现它
- **与对 OSINT 感兴趣的同事分享**
- **贡献**代码、数据源或文档
- **报告问题**以帮助改进平台

---

## License

麻省理工学院许可证 — 请参阅 [LICENSE](LICENSE) 了解详细信息。

---

## Author

**埃利·哈比卜** — [GitHub](https://github.com/koala73)

---

__持有人_0__
<a href="https://worldmonitor.app">worldmonitor.app</a>  · 
<a href="https://tech.worldmonitor.app">tech.worldmonitor.app</a>
__持有人_0__


## 明星历史

__持有人_0__
__持有人_0__
__持有人_0__
__持有人_0__
__持有人_0__
__持有人_0__
